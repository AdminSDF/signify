
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin by checking the 'isAdmin' field in their user document.
    function isAdmin(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.isAdmin == true;
    }

    // --- USERS ---
    match /users/{userId} {
      // CREATE: A user can create their own document when they sign up.
      allow create: if request.auth.uid == userId;

      // GET: A user can get their own document. An admin can get any user's document.
      allow get: if request.auth.uid == userId || isAdmin(request.auth.uid);
      
      // UPDATE: A user can update their own document. An admin can also update any user document.
      allow update: if request.auth.uid == userId || isAdmin(request.auth.uid);

      // LIST: An admin can list all users (for the admin panel). Authenticated users can list for the leaderboard.
      allow list: if request.auth != null;
    }

    // --- TRANSACTIONS ---
    match /transactions/{transactionId} {
      // CREATE: A user can create a transaction for themselves.
      allow create: if request.auth.uid == request.resource.data.userId;
      
      // READ (get/list): Admins can read all transactions. Users can only query and read their own.
      allow read: if isAdmin(request.auth.uid) || (request.auth.uid == resource.data.userId);
    }
    
    // --- WITHDRAWAL REQUESTS ---
    match /withdrawalRequests/{requestId} {
      // CREATE: A user can create their own withdrawal request.
      allow create: if request.auth.uid == request.resource.data.userId;
      
      // Admins can manage all requests. Users cannot see requests after creation.
      allow read, write, delete: if isAdmin(request.auth.uid);
    }
    
    // --- ADD FUND REQUESTS ---
    match /addFundRequests/{requestId} {
      // CREATE: A user can create their own add fund request.
      allow create: if request.auth.uid == request.resource.data.userId;
      
      // Admins can manage all requests. Users cannot see requests after creation.
      allow read, write, delete: if isAdmin(request.auth.uid);
    }
    
    // --- APP CONFIGURATION ---
    match /appConfiguration/{docId} {
      // GET: Any authenticated user can read the app configuration.
      allow get: if request.auth != null;
      
      // WRITE: Only admins can write/update the app configuration.
      allow write: if isAdmin(request.auth.uid);
    }
  }
}
