rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin.
    // It checks for the existence of the user document and the 'isAdmin' flag.
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Users Collection
    match /users/{userId} {
      // GET: An admin can get any user doc. A user can get their own.
      // LIST: Any authenticated user can list users (for the leaderboard).
      allow get: if request.auth.uid == userId || isAdmin();
      allow list: if request.auth != null;

      // WRITE: A user can create/update their own doc. An admin can update any doc.
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId || isAdmin();
    }

    // Transactions Collection
    match /transactions/{transactionId} {
      // READ (get/list): An admin can read any transaction. 
      // A normal user can only read their own transactions (this is enforced by the query in the app).
      allow read: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      
      // WRITE: A user can create their own transaction.
      allow create: if request.auth.uid == request.resource.data.userId;
    }
    
    // WithdrawalRequests Collection
    match /withdrawalRequests/{requestId} {
      // WRITE: A user can create their own request.
      allow create: if request.auth.uid == request.resource.data.userId;
      
      // Admin Access: Admins can read/write all requests. Regular users cannot access the list.
      allow read, write, list: if isAdmin();
    }
    
    // AddFundRequests Collection
    match /addFundRequests/{requestId} {
      // WRITE: A user can create their own request.
      allow create: if request.auth.uid == request.resource.data.userId;
      
      // Admin Access: Admins can read/write all requests. Regular users cannot access the list.
      allow read, write, list: if isAdmin();
    }

    // App Configuration
    match /appConfiguration/{docId} {
      // READ: Any authenticated user can read the app config.
      allow read: if request.auth != null;
      // WRITE: Only admins can write to the app config.
      allow write: if isAdmin();
    }
  }
}
