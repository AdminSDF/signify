
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Function to check if the requesting user is an admin
    function isAdmin() {
      // Check if the user document exists and has the isAdmin flag set to true.
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // A user can read and write to their own document.
      allow read, write: if request.auth.uid == userId;
      // An admin can get any single user's document.
      allow get: if isAdmin();
      // An admin can list all user documents (for the user overview table).
      allow list: if isAdmin();
    }

    // Rules for the 'transactions' collection
    match /transactions/{transactionId} {
      // A user can read their own transactions and create new ones for themselves.
      allow read, create: if request.auth.uid == request.resource.data.userId || (resource != null && request.auth.uid == resource.data.userId);
      // An admin can read any transaction and create transactions on behalf of users (for approvals).
      allow read, create: if isAdmin();
      // An admin can list all transactions.
      allow list: if isAdmin();
    }

    // Rules for both 'withdrawalRequests' and 'addFundRequests' collections
    match /{collectionId}/{requestId} where collectionId in ['withdrawalRequests', 'addFundRequests'] {
      // A user can create their own request and read their own requests.
      allow create: if request.auth.uid == request.resource.data.userId;
      allow read: if resource != null && request.auth.uid == resource.data.userId;

      // An admin can read, update, and list all requests in these collections.
      allow read, update, list: if isAdmin();
    }

    // Rules for the 'appConfiguration' collection
    match /appConfiguration/{docId} {
      // Anyone can read the app configuration (settings, news ticker).
      allow read: if true;
      // Only an admin can write to the app configuration.
      allow write: if isAdmin();
    }
  }
}
